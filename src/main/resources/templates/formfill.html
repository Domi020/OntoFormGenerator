<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fill form</title>
    <link rel="stylesheet" href="/material.min.css">
    <link rel="stylesheet" href="/selectize.default.min.css">
    <script src="/jquery-3.7.1.min.js"></script>
    <script src="/selectize.min.js"></script>
    <script src="/material.min.js"></script>
    <script src="/functions.js"></script>
    <script src="/js-loading-overlay.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
    <h1 th:text="${form}"></h1>
    <form id="fillform" th:action="@{/api/forms/{name}/fill(name=${form})}" method="post">
        <div class="mdl-textfield mdl-js-textfield">
            <input id="ontologyName" class="mdl-textfield__input" type="text" name="ontologyName"
                   th:value="${ontology}" readonly>
            <label class="mdl-textfield__label" for="ontologyName">Ontology</label>
        </div>
        <div class="mdl-textfield mdl-js-textfield">
            <input id="targetClass" class="mdl-textfield__input" type="text" name="targetClass"
                   th:value="${targetClass}" readonly>
            <label class="mdl-textfield__label" for="targetClass">Ontology</label>
        </div>
        <div class="mdl-textfield mdl-js-textfield">
            <input id="instanceName" class="mdl-textfield__input" type="text" name="instanceName">
            <label class="mdl-textfield__label" for="instanceName">Instance name</label>
        </div>
        <div th:each="field: ${formElements}">
            <div th:if="${field.fieldType == 'Input'}">
                <div th:replace="form-fields.html :: stringField (name=${field.name}, propName=${field.ontologyProperty.name})"></div>
            </div>
            <div th:if="${field.fieldType == 'Number'}">
                <div th:replace="form-fields.html :: numberField (name=${field.name}, propName=${field.ontologyProperty.name})"></div>
            </div>
            <div th:if="${field.fieldType == 'Datetime'}">
                <div th:replace="form-fields.html :: dateTimeField (name=${field.name}, propName=${field.ontologyProperty.name})"></div>
            </div>
            <div th:if="${field.fieldType == 'ObjectSelect'}">
                <div th:replace="form-fields.html :: objectSelectField (name=${field.name}, propName=${field.ontologyProperty.name})"></div>
            </div>
        </div>
        <div style="padding-top: 70px">
            <button type="submit" class="mdl-button mdl-js-button mdl-button--raised">Save</button>
        </div>
    </form>
    <dialog id="add-individual-dialog">
        <h2>Create new individual</h2>
        <p>How do you want to create a new individual for the following class?
        (The current form will be saved as draft)
        </p>
        <p id="create-individual-dialog-ontology-class"></p>
        <fieldset>
            <legend>Select a creation option.</legend>
            <div>
                <input type="radio" id="create-individual-dialog-option-1" name="create-individual-dialog-option"
                       value="1" checked>
                <label for="create-individual-dialog-option-1">Empty individual</label>
                <input type="text" name="create-individual-name" id="create-individual-name">
                <label for="create-individual-name">Individual name</label>
            </div>
            <div>
                <input type="radio" id="create-individual-dialog-option-2" name="create-individual-dialog-option"
                       value="2">
                <label for="create-individual-dialog-option-2">Create from form</label>
                <select id="create-individual-form-list"></select>
                <label for="create-individual-form-list">Forms</label>
            </div>
        </fieldset>
        <button>
            <a onclick="createIndividual()">Create individual</a>
        </button>
        <button class="close">
            <a>Cancel</a>
        </button>
    </dialog>
    <div style="padding-top: 100px">
        <a onclick="createDraftAndGoToHomepage()" id="create-draft-button" class="mdl-button mdl-js-button mdl-button--raised">
            Create draft
        </a>
    </div>
    <div style="padding-top: 100px">
        <a href="/" id="return-to-homepage-button" class="mdl-button mdl-js-button mdl-button--raised">
            Cancel
        </a>
    </div>
    <script th:inline="javascript">
        const ontologyName = [[${ontology}]];
        const allFormElements = [[${formElements}]];
        const formName = [[${form}]];
        const setElements = [[${setElements}]];
        JsLoadingOverlay.show({'spinnerIcon': 'ball-clip-rotate'});

        // noinspection JSUnusedGlobalSymbols
        function editIndividual(id) {
            createDraft().then(
                () => {
                    let indivName = $('#' + id)[0].value;
                    if (indivName === '') {
                        return;
                    }
                    location.href = '/edit/ontologies/' + ontologyName + '/individuals/' + indivName;
                }
            );
        }

        function addIndividual(propName) {
            let rangeName = allFormElements.find(formElement => formElement.ontologyProperty.name === propName).
                ontologyProperty.objectRange.name;
            document.getElementById('create-individual-dialog-ontology-class').innerText = rangeName;
            fetch(`/api/forms?ontologyName=${ontologyName}&targetClass=${rangeName}`)
                .then(async function(response) {
                    let allForms = await response.json();
                    let select = document.getElementById('create-individual-form-list');
                    for (let i = 0; i < allForms.length; i++) {
                        let option = document.createElement('option');
                        option.value = allForms[i].formName;
                        option.text = allForms[i].formName;
                        select.add(option);
                    }
                });
            const dialog = document.querySelector('#add-individual-dialog');
            dialog.showModal();
        }

        function createIndividual() {
            if (document.getElementById("create-individual-dialog-option-1").checked) {
                // Empty individual
                let individualName = document.getElementById("create-individual-name").value;
                let className = document.getElementById('create-individual-dialog-ontology-class').innerText
                if (individualName === '') {
                    alert('Individual name cannot be empty');
                    return;
                }
                fetch(`/api/ontologies/${ontologyName}/classes/${className}/individuals/${individualName}`, {
                    method: 'POST',
                }).then(() => {
                    let draftName = document.getElementById('instanceName').value;
                    createDraft().then(
                        () => location.href = '/fill/' + formName + '/draft/' + draftName
                    );
                });
            } else {

            }
        }

        function createDraftAndGoToHomepage() {
            createDraft().then(
                () => location.href = '/'
            ).catch();
        }

        async function createDraft() {
            const form = document.querySelector('#fillform');
            const formData = new FormData(form);
            let formString = {};
            formData.forEach(function(value, key){
                formString[key] = value;
            });
            if (formString['instanceName'] === '') {
                alert('Instance name cannot be empty');
                throw 0;
            }
            let formJSON = JSON.stringify(formString);
            return fetch(`/api/forms/${formName}/draft`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: formJSON,
            });
        }

        let promises = [];
        $(".object-select").each(function(index, element) {
            const fieldName = element.name;
            const fieldId = element.id;
            const currentFormElement = allFormElements
                .find(formElement => formElement.ontologyProperty.name === fieldName)
            const className = currentFormElement.ontologyProperty.objectRange.name;

            promises.push(fetch(`/api/ontologies/${ontologyName}/classes/${className}/individuals`)
                .then(async function(response) {
                    let allIndividuals = await response.json();
                    $('#' + fieldId).selectize({
                        valueField: 'name',
                        labelField: 'name',
                        searchField: 'name',
                        maxItems: 1,
                        options: allIndividuals,
                    });
                }));
        });

        Promise.all(promises).then(() => {
            if (setElements) {
                loadDraft();
            }
            JsLoadingOverlay.hide();
        });


        function loadDraft() {
            document.getElementById('instanceName').value = [[${individualName}]];
            for (let i = 0; i < setElements.length; i++) {
                const element = setElements[i];
                for (let j = 0; j < allFormElements.length; j++) {
                    if (allFormElements[j].ontologyProperty.name === element.fieldName) {
                        const input = document.getElementById('input-' + allFormElements[j].name);
                        if (input) {
                            input.value = element.value;
                            break;
                        }
                        const objectSelect = document.getElementById("object-select-" + allFormElements[j].name);
                        if (objectSelect) {
                            objectSelect.selectize.setValue(element.value);
                            break;
                        }
                        break;
                    }
                }
            }
        }

        const dialog = document.querySelector('#add-individual-dialog');
        dialog.querySelector('.close').addEventListener('click', function() {
            dialog.close();
        });

    </script>
</body>
</html>